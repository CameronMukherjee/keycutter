package com.hexploits.kc.service;

import com.hexploits.kc.dto.response.LoginLogResponse;
import com.hexploits.kc.model.KcUser;
import com.hexploits.kc.model.LoginResult;
import com.hexploits.kc.repository.KcLoginLogRepository;
import io.micronaut.data.model.Page;
import io.micronaut.data.model.Pageable;
import io.micronaut.data.model.Sort;
import io.micronaut.data.model.Sort.Order;
import io.micronaut.transaction.annotation.ReadOnly;
import jakarta.inject.Singleton;
import java.util.UUID;
import javax.transaction.Transactional;

@Singleton
public class KcLoginLogService {

  private final KcLoginLogRepository kcLoginLogRepository;
  private final KcUserService kcUserService;

  public KcLoginLogService(KcLoginLogRepository kcLoginLogRepository, KcUserService kcUserService) {
    this.kcLoginLogRepository = kcLoginLogRepository;
    this.kcUserService = kcUserService;
  }

  @ReadOnly
  public Page<LoginLogResponse> fetchLogs(Pageable pageable) {
    return kcLoginLogRepository.findAll(
      Pageable.from(pageable.getNumber(), pageable.getSize(), Sort.of(Order.desc("createdAt")))).map(log -> {

      KcUser user = kcUserService.fetchUser(log.getKcUserSid());

      return new LoginLogResponse(
        log.getUid(),
        user.getUsername(),
        user.getExternalReference(),
        log.getLoginResult(),
        log.getCreatedAt()
      );
    });
  }

  @ReadOnly
  public Page<LoginLogResponse> fetchLogsByUsername(String username, Pageable pageable) {
    Long userSid = kcUserService.fetchSidByUsername(username);
    return fetchLogsBySid(userSid, pageable);
  }

  @ReadOnly
  public Page<LoginLogResponse> fetchLogsByExternalReference(String externalReference, Pageable pageable) {
    Long userSid = kcUserService.fetchSidByExternalReference(externalReference);
    return fetchLogsBySid(userSid, pageable);
  }

  @Transactional
  public void writeLog(String username, LoginResult result) {
    kcLoginLogRepository.saveLog(UUID.randomUUID(), username, result);
  }

  private Page<LoginLogResponse> fetchLogsBySid(Long userSid, Pageable pageable) {
    return kcLoginLogRepository.findByKcUserSid(userSid, Pageable.from(pageable.getNumber(), pageable.getSize()))
      .map(log -> {
        KcUser user = kcUserService.fetchUser(log.getKcUserSid());

        return new LoginLogResponse(
          log.getUid(),
          user.getUsername(),
          user.getExternalReference(),
          log.getLoginResult(),
          log.getCreatedAt()
        );
      });
  }
}
