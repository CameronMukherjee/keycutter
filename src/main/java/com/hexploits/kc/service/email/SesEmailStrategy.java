package com.hexploits.kc.service.email;

import com.hexploits.kc.service.InternalResourceLoader;
import io.micronaut.context.annotation.Replaces;
import io.micronaut.context.annotation.Requires;
import io.micronaut.context.annotation.Value;
import io.micronaut.email.Email;
import io.micronaut.email.EmailSender;
import io.micronaut.email.MultipartBody;
import jakarta.inject.Singleton;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

@Singleton
@Replaces(IEmailService.class)
@Requires(property = "kc.email.provider", value = "ses")
public class SesEmailStrategy implements IEmailService {

  private final String sender;
  private final EmailSender<?, ?> emailSender;
  private final InternalResourceLoader resourceLoader;
  private final Logger log = LoggerFactory.getLogger(SesEmailStrategy.class);

  public SesEmailStrategy(
    @Value("${kc.email.sender}") String sender,
    EmailSender<?, ?> emailSender,
    InternalResourceLoader resourceLoader) {
    this.sender = sender;
    this.emailSender = emailSender;
    this.resourceLoader = resourceLoader;
  }

  @Override
  public void sendWelcome(String receiver) {
    log.info("Sending welcome email to {} from {} via SES", receiver, sender);

    emailSender.send(Email
      .builder()
      .from(sender)
      .to(receiver)
      .subject(resourceLoader.fetchWelcomeSubject())
      .body(new MultipartBody(resourceLoader.fetchWelcomeBody(), "Welcome"))
    );
  }

  @Override
  public void sendPasswordReset(String receiver, String newPassword) {
    log.info("Sending password reset email to {} from {} via SES", receiver, sender);

    String body = String.format(resourceLoader.fetchPasswordResetBody(), newPassword);

    emailSender.send(Email
      .builder()
      .from(sender)
      .to(receiver)
      .subject(resourceLoader.fetchPasswordResetSubject())
      .body(new MultipartBody(body, "TEXT HERE"))
    );
  }

}
