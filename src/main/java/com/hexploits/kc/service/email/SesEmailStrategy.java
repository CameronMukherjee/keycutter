package com.hexploits.kc.service.email;

import com.hexploits.kc.model.EventType;
import com.hexploits.kc.model.KcUser;
import com.hexploits.kc.service.InternalResourceLoader;
import com.hexploits.kc.service.event.internal.KcCommandEvent;
import com.hexploits.kc.service.event.internal.KcCommandPublisher;
import io.micronaut.context.annotation.Replaces;
import io.micronaut.context.annotation.Requires;
import io.micronaut.context.annotation.Value;
import io.micronaut.email.Email;
import io.micronaut.email.EmailSender;
import io.micronaut.email.MultipartBody;
import jakarta.inject.Singleton;
import java.time.LocalDate;
import java.util.Optional;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

@Singleton
@Replaces(IEmailStrategy.class)
@Requires(property = "kc.email.provider", value = "ses")
@Requires(property = "kc.email.sender")
public class SesEmailStrategy implements IEmailStrategy {

  private final String sender;
  private final EmailSender<?, ?> emailSender;
  private final InternalResourceLoader resourceLoader;
  private final Logger log = LoggerFactory.getLogger(SesEmailStrategy.class);
  private final KcCommandPublisher kcCommandPublisher;

  public SesEmailStrategy(
    @Value("${kc.email.sender}") String sender,
    EmailSender<?, ?> emailSender,
    InternalResourceLoader resourceLoader,
    KcCommandPublisher kcCommandPublisher) {
    this.sender = sender;
    this.emailSender = emailSender;
    this.resourceLoader = resourceLoader;
    this.kcCommandPublisher = kcCommandPublisher;
  }

  @Override
  public void sendWelcome(KcUser user) {
    log.info("Sending welcome email to {} from {} via SES", user.getUsername(), sender);

    emailSender.send(Email
      .builder()
      .from(sender)
      .to(user.getUsername())
      .subject(resourceLoader.fetchWelcomeSubject())
      .body(new MultipartBody(resourceLoader.fetchWelcomeBody(), "Welcome"))
    );

    kcCommandPublisher.publishEvent(
      new KcCommandEvent(
        SesEmailStrategy.class,
        Optional.of(user),
        EventType.WELCOME_EMAIL_DISPATCHED,
        Optional.empty()
      )
    );
  }

  @Override
  public void sendPasswordReset(KcUser user, String newPassword) {
    log.info("Sending password reset email to {} from {} via SES", user.getUsername(), sender);

    String body = String.format(resourceLoader.fetchPasswordResetBody(), newPassword);

    emailSender.send(Email
      .builder()
      .from(sender)
      .to(user.getUsername())
      .subject(resourceLoader.fetchPasswordResetSubject())
      .body(new MultipartBody(body, "Your new password: " + newPassword))
    );

    kcCommandPublisher.publishEvent(
      new KcCommandEvent(
        SesEmailStrategy.class,
        Optional.of(user),
        EventType.FORGOTTEN_PASSWORD_EMAIL_DISPATCHED,
        Optional.of("Temporary password is: " + newPassword)
      )
    );
  }

  @Override
  public void sendEndOfDayEmail(Long registrationsToday,
    Long totalRegisteredUsers,
    Long loginLogCount,
    Long eventLogCount) {
    log.info("Dispatching end of day email TO: {} FROM {}", sender, sender);
    String subject = LocalDate.now() + " - KeyCutter Daily Recap";

    String body = String.format(
      "Total Registrations Today: %d<br>"
        + "Total Registered Users: %d<br>"
        + "Total Login Logs: %d<br>"
        + "Total Event Logs: %d<br>"
        + "<small>KeyCutter by Hexploits</small>", registrationsToday,
      totalRegisteredUsers,
      loginLogCount,
      eventLogCount);

    emailSender.send(Email
      .builder()
      .from(sender)
      .to(sender)
      .subject(subject)
      .body(new MultipartBody(body, body)));

    kcCommandPublisher.publishEvent(
      new KcCommandEvent(
        SesEmailStrategy.class,
        Optional.empty(),
        EventType.END_OF_DAY_EMAIL_SENT,
        Optional.empty()
      )
    );
  }

}
