package com.hexploits.kc.service.email;

import com.hexploits.kc.model.KcUser;
import com.hexploits.kc.service.KcUserService;
import com.hexploits.kc.service.event.KcCommandEvent;
import com.hexploits.kc.service.event.KcCommandPublisher;
import io.micronaut.context.annotation.Primary;
import io.micronaut.context.annotation.Replaces;
import io.micronaut.context.annotation.Requires;
import jakarta.inject.Singleton;
import java.util.Optional;
import model.EventType;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

@Primary
@Singleton
@Replaces(IEmailService.class)
@Requires(property = "kc.env", value = "local")
@Requires(property = "kc.email.provider", value = "none")
public class LocalEmailStrategy implements IEmailService {

  private final Logger log = LoggerFactory.getLogger(LocalEmailStrategy.class);
  private final KcCommandPublisher kcCommandPublisher;

  public LocalEmailStrategy(KcCommandPublisher kcCommandPublisher) {
    this.kcCommandPublisher = kcCommandPublisher;
  }

  @Override
  public void sendWelcome(KcUser user) {
    log.info("Welcome email would of been dispatched to: {}", user.getUsername());

    kcCommandPublisher.publishEvent(
      new KcCommandEvent(
        KcUserService.class,
        user.getUid(),
        user.getUsername(),
        user.getExternalReference(),
        EventType.WELCOME_EMAIL_DISPATCHED,
        Optional.empty()
      )
    );
  }

  @Override
  public void sendPasswordReset(KcUser user, String newPassword) {
    log.info(
      "Password reset would of been dispatched to: {} - temporary password is: {}",
      user.getUsername(),
      newPassword
    );

    kcCommandPublisher.publishEvent(
      new KcCommandEvent(
        KcUserService.class,
        user.getUid(),
        user.getUsername(),
        user.getExternalReference(),
        EventType.WELCOME_EMAIL_DISPATCHED,
        Optional.of("Temporary password is: " + newPassword)
      )
    );
  }
}
