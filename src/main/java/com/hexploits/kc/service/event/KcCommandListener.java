package com.hexploits.kc.service.event;

import com.hexploits.kc.service.KcEventLogService;
import com.hexploits.kc.service.webhook.IWebhookDispatchService;
import io.micronaut.context.event.ApplicationEventListener;
import jakarta.inject.Singleton;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import reactor.util.annotation.NonNull;

@Singleton
public class KcCommandListener implements ApplicationEventListener<KcCommandEvent> {

  private final Logger log = LoggerFactory.getLogger(KcCommandListener.class);
  private final IWebhookDispatchService webhookDispatchService;
  private final KcEventLogService kcEventLogService;

  public KcCommandListener(IWebhookDispatchService webhookDispatchService,
    KcEventLogService kcEventLogService) {
    this.webhookDispatchService = webhookDispatchService;
    this.kcEventLogService = kcEventLogService;
  }

  @Override
  public void onApplicationEvent(@NonNull KcCommandEvent event) {
    webhookDispatchService.emit(event.getUserUid(), event.getExternalReference(), event.getEventType());
    kcEventLogService.writeLog(event.getUserUid(), event.getEventType());
  }
}
