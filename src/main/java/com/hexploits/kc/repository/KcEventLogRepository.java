package com.hexploits.kc.repository;

import com.hexploits.kc.dto.internal.EventType;
import com.hexploits.kc.model.KcEventLog;
import io.micronaut.core.annotation.Nullable;
import io.micronaut.data.annotation.Query;
import io.micronaut.data.jdbc.annotation.JdbcRepository;
import io.micronaut.data.model.query.builder.sql.Dialect;
import io.micronaut.data.repository.CrudRepository;
import java.time.OffsetDateTime;
import java.util.List;
import java.util.UUID;

@JdbcRepository(dialect = Dialect.POSTGRES)
public interface KcEventLogRepository extends CrudRepository<KcEventLog, UUID> {

  //language=sql
  @Query("INSERT INTO kc_event_log(uid, kc_user_sid, event_type, metadata) VALUES (:logUid, (SELECT sid from kc_user WHERE uid = :userUid), :eventType::event_type, :metadata);")
  void writeLog(UUID logUid, UUID userUid, EventType eventType, @Nullable String metadata);

  //language=sql
  @Query("SELECT l.uid, u.uid as user_uid, u.username, l.event_type, l.metadata, l.created_at FROM kc_event_log l JOIN kc_user u on u.sid = l.kc_user_sid ORDER BY l.created_at DESC LIMIT :limit")
  List<KcEventLog> fetchLogs(int limit);

  //language=sql
  @Query("SELECT l.uid, u.uid as user_uid, u.username, l.event_type, l.metadata, l.created_at FROM kc_event_log l JOIN kc_user u on u.sid = l.kc_user_sid WHERE u.username = :username ORDER BY l.created_at DESC LIMIT :limit")
  List<KcEventLog> fetchLogsByUsername(String username, int limit);

  //language=sql
  @Query("SELECT l.uid, u.uid as user_uid, u.username, l.event_type, l.metadata, l.created_at FROM kc_event_log l JOIN kc_user u on u.sid = l.kc_user_sid WHERE u.external_reference = :externalReference ORDER BY l.created_at DESC LIMIT :limit")
  List<KcEventLog> fetchLogsByExternalReference(String externalReference, int limit);

  //language=sql
  @Query("SELECT l.uid, u.uid as user_uid, u.username, l.event_type, l.metadata, l.created_at FROM kc_event_log l JOIN kc_user u on u.sid = l.kc_user_sid WHERE l.created_at < :datetime ORDER BY l.created_at DESC")
  List<KcEventLog> fetchLogsBefore(OffsetDateTime datetime);

  //language=sql
  @Query("DELETE FROM kc_event_log WHERE created_at < :datetime")
  void deleteLogsBefore(OffsetDateTime datetime);
}
